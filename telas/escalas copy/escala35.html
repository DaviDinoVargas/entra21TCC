<!DOCTYPE html>
<html>

<head>
  <meta charset="ISO-8859-1">
  <title>Testes</title>
  <link rel="stylesheet" href="./css/escalasC.css">
  <link rel="stylesheet" href="./css/menu.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
</head>

<body>
  <script src="./script/header.js"></script>
  <form id="formPage3">
    <label for="comentarioDM3">Coment√°rio:</label>
    <textarea id="comentarioDM3" rows="4" cols="50" required></textarea>

    <button type="button" onclick="saveDataAndSubmit()">Salvar</button>
  </form>

  <script>
    function saveDataAndSubmit() {
      
      const op3_1 = parseInt(localStorage.getItem('op3_1'));
      const op3_2 = parseInt(localStorage.getItem('op3_2'));
      const op3_3 = parseInt(localStorage.getItem('op3_3'));
      const op3_4 = parseInt(localStorage.getItem('op3_4'));
      const op3_5 = parseInt(localStorage.getItem('op3_5'));
      const op3_6 = parseInt(localStorage.getItem('op3_6'));
      const op3_7 = parseInt(localStorage.getItem('op3_7'));
      const op3_8 = parseInt(localStorage.getItem('op3_8'));
      const cpfPacEscala = localStorage.getItem('cpfPacEscala'); 

      const somaDM3 = op3_1 + op3_2 + op3_3 + op3_4 + op3_5 + op3_6 + op3_7 + op3_8;

      localStorage.setItem('comentarioDM3', document.getElementById('comentarioDM3').value);

      const url = `http://localhost:8080/auth/pacientes/cpf/${cpfPacEscala}`;
      fetch(url)
        .then(response => response.json())
        .then(patientData => {
          const patientId = patientData.id_paciente;
          console.log(patientId);
          const data = {
            op3_1: op3_1,
            op3_2: op3_2,
            op3_3: op3_3,
            op3_4: op3_4,
            op3_5: op3_5,
            op3_6: op3_6,
            op3_7: op3_7,
            op3_8: op3_8,
            somaDM3: somaDM3,
            comentarioDM3: localStorage.getItem('comentarioDM3'),
            cpf_paciente: cpfPacEscala,
            id_paciente: patientId  
          };

          
          fetch('http://localhost:8080/auth/registraEscala3', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          })
          .then(response => response.json())
          .then(data => {
            console.log('Dados enviados com sucesso:', data);
            alert('Dados enviados com sucesso!');
            
            
            for (let key in localStorage) {
              if (key !== 'cpfPacEscala') {
                localStorage.removeItem(key);
              }
            }
            localStorage.setItem('cpfPacEscala', cpfPacEscala);

            
            window.location.href = `newpac.html?id=${patientId}`;
          })
          .catch(error => {
            console.error('Erro ao enviar dados:', error);
            alert('Erro ao enviar dados. Por favor, tente novamente.');
          });
        })
        .catch(error => {
          console.error('Erro ao obter o ID do paciente:', error);
          alert('Erro ao obter o ID do paciente. Por favor, tente novamente.');
        });
    }
  </script>
</body>
</html>
